<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLHMI - Pelaksana</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary: #003366;
            --accent: #ffcc00;
            --bg: #f4f7f9;
            --ok: #2e7d32;
            --ng: #d32f2f;
        }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Arial; background: var(--bg); color: #333; touch-action: manipulation; }
        .card { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,.1); }
        .header { background: var(--primary); color: #fff; padding: 20px; text-align: center; font-weight: bold; font-size: 1.1rem; position: sticky; top: 0; z-index: 100; }
        .section { padding: 20px; }
        input, select, textarea { width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:active { transform: scale(0.98); background: #002244; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
        .category { background: #003366; color: #fff; font-weight: 800; font-size: 13px; text-transform: uppercase; }
        .item-text { font-size: 14px; font-weight: 600; color: #1e293b; }
        .item-std { font-size: 11px; color: #64748b; display: block; margin-top: 4px; line-height: 1.4; }
        .note { display: none; margin-top: 8px; background: #fff5f5; border: 1px solid #feb2b2; font-size: 13px; height: 60px; }
        .canvas-box { position: relative; border: 2px solid #cbd5e1; border-radius: 10px; background: #fff; margin-top: 10px; overflow: hidden; }
        canvas { display: block; width: 100%; height: 200px; touch-action: none; background-color: #fcfcfc; }
        .canvas-label { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 5px 0; }
        .info-box { background: #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; line-height: 1.5; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

<div class="card">
    <div class="header">CHECKLIST HARIAN MESIN INJECTION (CLHMI)</div>

    <div class="section" id="login">
        <h3>üë∑ Nama Pelaksana</h3>
        <input id="nama_pelaksana" type="text" placeholder="Masukkan nama lengkap...">
        <button class="btn btn-primary" onclick="startScan()">SCAN QR MESIN</button>
    </div>

    <div class="section" id="scan" style="display:none">
        <div id="reader"></div>
        <p style="text-align:center; color:#64748b">Arahkan kamera ke QR Code Mesin</p>
        <button class="btn" onclick="location.reload()" style="background:#ef4444; color:white">BATAL</button>
    </div>

    <div class="section" id="form" style="display:none">
        <div class="info-box" id="infoBox">
            <b>UNIT:</b> <span id="m_name">-</span><br>
            <b>SERIAL:</b> <span id="m_serial">-</span> | <b>TONNAGE:</b> <span id="m_ton">-</span><br>
            <b>PELAKSANA:</b> <span id="m_user">-</span>
        </div>

        <form id="clForm">
            <table>
                <tbody id="tbody"></tbody>
            </table>

            <div class="canvas-label">
                <label><b>‚úçÔ∏è Paraf Digital Pelaksana:</b></label>
                <button type="button" onclick="clearCanvas()" style="color:var(--ng); background:none; border:none; font-size:12px; font-weight:bold; cursor:pointer;">HAPUS PARAF</button>
            </div>
            <div class="canvas-box">
                <canvas id="canvas"></canvas>
            </div>

            <br><br>
            <button class="btn btn-primary" type="submit" id="btnSimpan">SIMPAN CHECKLIST</button>
            <div style="height: 50px;"></div>
        </form>
    </div>
</div>

<script>
const supabaseUrl = "https://duljhawudstjxibhuenv.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bGpoYXd1ZHN0anhpYmh1ZW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODI2NDksImV4cCI6MjA4MTM1ODY0OX0.R9s6oNlJjF_K89frPmWkXxcOBlO1IJL6nXwxqNV1jiQ";
const sb = supabase.createClient(supabaseUrl, supabaseKey);

let html5QrCode;
let machine = null;

const items = [
    {cat:"1. MEKANIKAL", list:[
        {id:"mek_a",txt:"Nozzle visual",std:"Radius tidak rusak, tidak meler"},
        {id:"mek_b",txt:"Kebersihan Head Nozzle barrel",std:"Tidak ada material menempel"},
        {id:"mek_c",txt:"Check level oli mesin",std:"> Level garis tengah"},
        {id:"mek_d",txt:"Check pump central lubrikasi",std:"Berfungsi baik"},
        {id:"mek_e",txt:"Check keseluruhan kondisi mesin",std:"Lengkap dan bersih"},
        {id:"mek_f",txt:"Check kondisi lampu indicator",std:"Nyala sesuai fungsi"},
        {id:"mek_g",txt:"Pastikan pintu panel kontrol tertutup",std:"Tertutup"},
        {id:"mek_h",txt:"Check temperatur oli",std:"40 - 50¬∞C"},
        {id:"mek_i",txt:"Running hour (jam)",std:"Sesuai aktual mesin"}
    ]},
    {cat:"2. KEBERSIHAN DEBU", list:[
        {id:"deb_a",txt:"Pintu Mesin (kaca/acrylic)",std:"Bersih tidak berdebu"},
        {id:"deb_b",txt:"Kap mesin",std:"Bersih tidak berdebu"},
        {id:"deb_c",txt:"Kap inject unit",std:"Bersih tidak berdebu"},
        {id:"deb_d",txt:"Panel mesin",std:"Bersih tidak berdebu"}
    ]},
    {cat:"3. KEBERSIHAN OLI", list:[
        {id:"oli_a",txt:"Lantai area mesin",std:"Tidak kotor oli"},
        {id:"oli_b",txt:"Bawah mesin",std:"Tidak kotor oli"},
        {id:"oli_c",txt:"Bawah inject unit",std:"Tidak kotor oli"}
    ]},
    {cat:"4. KEBERSIHAN AIR", list:[
        {id:"air_a",txt:"Pemeriksaan instalasi air",std:"Fitting / ballvalve tidak bocor"},
        {id:"air_b",txt:"Embun pipa chiller",std:"Dilindungi armaflex"}
    ]},
    {cat:"5. KEBERSIHAN AREA MESIN", list:[
        {id:"area_a",txt:"Pemeriksaan alat kerja/ sparepart setelah perbaikan",std:"Area mesin bersih, tidak terdapat ceceran tools & sparepart"},
        {id:"area_b",txt:"Kelengkapan selang angin spiral & air gun",std:"Terpasang rapih, lengkap dan berfungsi"}
    ]}
];

function startScan(){
    const p = document.getElementById("nama_pelaksana").value;
    if(!p) return alert("Isi nama pelaksana!");
    document.getElementById("login").style.display = "none";
    document.getElementById("scan").style.display = "block";
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
}

async function onScanSuccess(decodedText) {
    await html5QrCode.stop();
    const { data, error } = await sb.from("clhmi_machine").select("*").eq("merk_mesin", decodedText.trim()).eq("aktif", true).single();
    if(error || !data) {
        alert("MESIN TIDAK TERDAFTAR!");
        location.reload();
        return;
    }
    machine = data;
    showForm();
}

function showForm() {
    document.getElementById("scan").style.display = "none";
    document.getElementById("form").style.display = "block";
    document.getElementById("m_name").innerText = machine.merk_mesin;
    document.getElementById("m_serial").innerText = machine.serial_no;
    document.getElementById("m_ton").innerText = machine.tonage;
    document.getElementById("m_user").innerText = document.getElementById("nama_pelaksana").value;

    const tb = document.getElementById("tbody");
    let h = "";
    items.forEach(g => {
        h += `<tr class="category"><td colspan="2">${g.cat}</td></tr>`;
        g.list.forEach(i => {
            h += `<tr><td><span class="item-text">${i.txt}</span><br><span class="item-std">${i.std}</span><textarea class="note" id="note_${i.id}" placeholder="Temuan NG..."></textarea></td><td><select id="st_${i.id}" onchange="chg('${i.id}',this)"><option value="OK">OK</option><option value="NG">NG</option></select></td></tr>`;
        });
    });
    tb.innerHTML = h;
    initCanvas();
}

function chg(id, el){ document.getElementById("note_"+id).style.display = (el.value === "NG") ? "block" : "none"; }

/* CANVAS PARAF */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let isDrawing = false;
function initCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.strokeStyle = "#003366"; ctx.lineWidth = 4; ctx.lineCap = "round"; ctx.lineJoin = "round";
}
function getCoords(e) {
    const rect = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: cx - rect.left, y: cy - rect.top };
}
canvas.addEventListener("mousedown", (e) => { isDrawing = true; const p = getCoords(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
canvas.addEventListener("mousemove", (e) => { if(!isDrawing) return; const p = getCoords(e); ctx.lineTo(p.x, p.y); ctx.stroke(); });
window.addEventListener("mouseup", () => isDrawing = false);
canvas.addEventListener("touchstart", (e) => { isDrawing = true; const p = getCoords(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive:false});
canvas.addEventListener("touchmove", (e) => { if(!isDrawing) return; const p = getCoords(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive:false});
function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); }

/* SUBMIT REVISI - UPSERT MODE */
document.getElementById("clForm").onsubmit = async (e) => {
    e.preventDefault();
    const sig = canvas.toDataURL();
    if(sig.length < 3000) return alert("Mohon isi paraf!");

    const btn = document.getElementById("btnSimpan");
    btn.disabled = true;
    btn.innerText = "MENYIMPAN...";

    const now = new Date();
    const payload = {
        machine_id: machine.id,
        merk_mesin: machine.merk_mesin,
        tonage: machine.tonage,
        serial_no: machine.serial_no,
        tahun: now.getFullYear(),
        bulan: now.getMonth() + 1,
        paraf: sig,
        created_by: document.getElementById("nama_pelaksana").value,
        status_form: "submitted"
    };

    const { data: hdr, error: e1 } = await sb
        .from("clhmi")
        .upsert(payload, { onConflict: "machine_id,bulan,tahun" })
        .select()
        .single();

    if (e1) {
        alert("Error Header: " + e1.message);
        btn.disabled = false;
        btn.innerText = "SIMPAN CHECKLIST";
        return;
    }

    const rows = [];
    items.forEach(g => {
        g.list.forEach(i => {
            rows.push({
                clhmi_id: hdr.id,
                item_code: i.id,
                status: document.getElementById("st_"+i.id).value,
                note: document.getElementById("note_"+i.id).value || null
            });
        });
    });

    // Jika UPSERT, sebaiknya hapus result lama dulu atau DB akan duplikat detail
    await sb.from("clhmi_results").delete().eq("clhmi_id", hdr.id);
    
    const { error: e2 } = await sb.from("clhmi_results").insert(rows);
    
    if(e2) alert("Error Detail: " + e2.message);
    else {
        alert("‚úÖ Checklist Berhasil Disimpan!");
        location.reload();
    }
};
</script>
</body>
</html>
