<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLHMI - Pelaksana</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
:root{
  --primary:#003366;
  --accent:#ffcc00;
  --bg:#f4f7f9;
}
body{margin:0;font-family:Segoe UI,Arial;background:var(--bg);touch-action: manipulation;}
.card{max-width:900px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);overflow:hidden}
.header{background:var(--primary);color:#fff;padding:20px;text-align:center;font-size:1.4em;font-weight:bold}
.section{padding:20px}
input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #cbd5e1;margin:8px 0;box-sizing:border-box}
.btn{padding:14px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;width:100%;margin-top:15px}
.btn-primary{background:var(--primary);color:#fff;font-size:1.1em}
#reader{width:100%;height:300px;background:#000;border-radius:12px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:left}
th{background:#f1f5f9}
.category{background:#003366;color:#fff;font-weight:bold}
.note{display:none;margin-top:8px}
.info-box{background:#f1f5f9;padding:15px;border-radius:10px;margin-bottom:20px;font-size:15px}
#signature-pad{border:2px dashed #999;border-radius:12px;background:#fafafa;width:100%;height:200px;cursor:crosshair}
#clearSig{color:red;background:none;border:none;font-size:1em;margin-top:8px;cursor:pointer}
@media (max-width: 600px) {
  .header{font-size:1.2em;padding:15px}
  .section{padding:15px}
  th,td{padding:10px}
  #signature-pad{height:150px}
}
@media (min-width: 601px) and (max-width: 900px) {
  .header{font-size:1.3em}
  #signature-pad{height:180px}
}
</style>
</head>
<body>

<div class="card">
  <div class="header">CHECKLIST HARIAN MESIN INJECTION (CLHMI)</div>

  <!-- LOGIN -->
  <div class="section" id="login">
    <h3>Nama Pelaksana</h3>
    <input id="nama_pelaksana" placeholder="Masukkan nama lengkap">
    <button class="btn btn-primary" onclick="startScan()">SCAN QR MESIN</button>
  </div>

  <!-- SCANNER -->
  <div class="section" id="scan" style="display:none;padding:10px">
    <div id="reader"></div>
    <p style="text-align:center;margin:10px 0;color:#555">Arahkan kamera ke QR Code mesin</p>
  </div>

  <!-- FORM CHECKLIST -->
  <div class="section" id="form" style="display:none">
    <div class="info-box">
      <b>UNIT :</b> <span id="m_name"></span><br>
      <b>SERIAL :</b> <span id="m_serial"></span><br>
      <b>TONNAGE :</b> <span id="m_ton"></span><br>
      <b>PELKS :</b> <span id="m_user"></span>
    </div>

    <form id="clForm">
      <table>
        <thead>
          <tr><th>Item & Standar</th><th>Status</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <h4>Paraf Digital / Tanda Tangan</h4>
      <canvas id="signature-pad"></canvas>
      <button type="button" id="clearSig">Hapus Tanda Tangan</button>

      <button type="submit" class="btn btn-primary" style="margin-top:25px">
        SIMPAN CHECKLIST
      </button>
    </form>
  </div>
</div>

<script>
// === SUPABASE ===
const sb = supabase.createClient(
  "https://duljhawudstjxibhuenv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bGpoYXd1ZHN0anhpYmh1ZW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODI2NDksImV4cCI6MjA4MTM1ODY0OX0.R9s6oNlJjF_K89frPmWkXxcOBlO1IJL6nXwxqNV1jiQ"
);

let html5QrCode, machine = null, clhmi_id = null;

// === SEMUA ITEM SESUAI EXCEL ===
const items = [
 {cat:"1. MEKANIKAL", list:[
  {id:"mek_a",txt:"Nozzle visual",std:"Radius tidak rusak, tidak ada lelehan material meler"},
  {id:"mek_b",txt:"Kebersihan Head Nozzle barrel",std:"Tidak ada material yang menempel"},
  {id:"mek_c",txt:"Check level oli mesin",std:"> Level garis tengah"},
  {id:"mek_d",txt:"Check pump central lubrikasi",std:"Berfungsi baik"},
  {id:"mek_e",txt:"Check keseluruhan kondisi mesin",std:"Lengkap dan bersih"},
  {id:"mek_f",txt:"Check kondisi lampu indicator",std:"Nyala sesuai fungsi"},
  {id:"mek_g",txt:"Pastikan pintu panel kontrol tertutup",std:"Tertutup"},
  {id:"mek_h",txt:"Check temperatur oli",std:"40 - 50Â°C"},
  {id:"mek_i",txt:"Running hour (jam)",std:"Sesuai aktual mesin"}
 ]},
 {cat:"2. KEBERSIHAN DEBU", list:[
  {id:"deb_a",txt:"Pintu Mesin (kaca/acrylic)",std:"Bersih tidak berdebu"},
  {id:"deb_b",txt:"Kap mesin",std:"Bersih tidak berdebu"},
  {id:"deb_c",txt:"Kap inject unit",std:"Bersih tidak berdebu"},
  {id:"deb_d",txt:"Panel mesin",std:"Bersih tidak berdebu"}
 ]},
 {cat:"3. KEBERSIHAN OLI", list:[
  {id:"oli_a",txt:"Lantai area mesin",std:"Tidak kotor oli"},
  {id:"oli_b",txt:"Bawah mesin",std:"Tidak kotor oli"},
  {id:"oli_c",txt:"Bawah inject unit",std:"Tidak kotor oli"}
 ]},
 {cat:"4. KEBERSIHAN AIR", list:[
  {id:"air_a",txt:"Pemeriksaan instalasi air",std:"Fitting / ballvalve tidak bocor"},
  {id:"air_b",txt:"Embun pipa chiller",std:"Dilindungi armaflex"}
 ]},
 {cat:"5. KEBERSIHAN AREA MESIN", list:[
  {id:"area_a",txt:"Pemeriksaan alat kerja/sparepart setelah perbaikan",std:"Area bersih, tidak ada ceceran tools & sparepart"},
  {id:"area_b",txt:"Kelengkapan selang angin spiral & air gun",std:"Terpasang rapi, lengkap dan berfungsi"}
 ]}
];

// === BUILD CHECKLIST ===
function buildItems(){
  let html = "";
  items.forEach(g=>{
    html += `<tr class="category"><td colspan="2">${g.cat}</td></tr>`;
    g.list.forEach(i=>{
      html += `
      <tr>
        <td>${i.txt}<br><small style="color:#555">${i.std}</small>
          <textarea class="note" id="note_${i.id}" placeholder="Catatan jika NG" style="height:60px;font-size:14px"></textarea>
        </td>
        <td style="width:120px">
          <select id="st_${i.id}" onchange="toggleNote('${i.id}',this)" style="width:100%;padding:10px">
            <option value="OK">OK</option>
            <option value="NG">NG</option>
          </select>
        </td>
      </tr>`;
    });
  });
  document.getElementById("tbody").innerHTML = html;
}
function toggleNote(id, el){
  document.getElementById("note_"+id).style.display = el.value==="NG" ? "block" : "none";
}

// === QR SCAN ===
function startScan(){
  if(!nama_pelaksana.value.trim()) return alert("Isi nama pelaksana dulu");
  login.style.display="none";
  scan.style.display="block";
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: {width:250,height:250} },
    async (text) => {
      html5QrCode.stop();
      const {data,error} = await sb.from("clhmi_machine").select("*").eq("merk_mesin",text.trim()).eq("aktif",true).single();
      if(error || !data) return alert("QR tidak terdaftar atau mesin tidak aktif");
      machine = data;
      scan.style.display="none";
      form.style.display="block";
      m_name.innerText   = data.merk_mesin;
      m_serial.innerText = data.serial_no || "-";
      m_ton.innerText    = data.tonage || "-";
      m_user.innerText   = nama_pelaksana.value;
      buildItems();
      initSignaturePad();
    }
  ).catch(err=>alert("Gagal akses kamera: "+err));
}

// === TANDA TANGAN YANG BENAR-BENAR LANCAR DI HP ===
let canvas = document.getElementById("signature-pad");
let ctx = canvas.getContext("2d");
let isDrawing = false;
let lastX = 0, lastY = 0;

function initSignaturePad(){
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";

  const startDraw = (e) => {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    lastY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  };
  const draw = (e) => {
    if(!isDrawing) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    [lastX, lastY] = [x, y];
  };
  const stopDraw = () => { isDrawing = false; };

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", stopDraw);
  canvas.addEventListener("mouseout", stopDraw);

  canvas.addEventListener("touchstart", startDraw);
  canvas.addEventListener("touchmove", draw);
  canvas.addEventListener("touchend", stopDraw);
}

document.getElementById("clearSig").onclick = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
};

// === SIMPAN KE SUPABASE ===
clForm.onsubmit = async (e) => {
  e.preventDefault();
  const signature = canvas.toDataURL("image/png");
  if(canvas.width * canvas.height < 10000 || signature.length < 3000){
    return alert("Tanda tangan belum dibuat / terlalu kecil");
  }

  // Insert header
  const {data: header, error: e1} = await sb
    .from("clhmi")
    .insert({
      machine_id: machine.id,
      pelaksana: nama_pelaksana.value.trim(),
      paraf: signature
    })
    .select()
    .single();

  if(e1) return alert("Error header: "+e1.message);
  clhmi_id = header.id;

  // Insert detail
  let details = [];
  items.forEach(g=>g.list.forEach(i=>{
    details.push({
      clhmi_id,
      item_code: i.id,
      status: document.getElementById("st_"+i.id).value,
      note: document.getElementById("note_"+i.id).value || null
    });
  }));

  const {error: e2} = await sb.from("clhmi_results").insert(details);
  if(e2) return alert("Error detail: "+e2.message);

  alert("Checklist berhasil disimpan!");
  location.reload();
};
</script>
</body>
</html>
