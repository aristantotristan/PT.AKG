<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Checklist Stand Label & Robot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 15px; margin: 0; }
    .progress-container { width: 100%; background: #ddd; height: 8px; margin-bottom: 20px; border-radius: 4px; }
    .progress-bar { height: 100%; width: 0%; background: #003366; transition: 0.3s; border-radius: 4px; }
    .step { display: none; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .step.active { display: block; }
    .item { margin-bottom: 15px; }
    label { font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px; }
    select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    textarea { margin-top: 5px; display: none; height: 60px; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    button { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .back { background: #ccc; }
    .next { background: #003366; color: #fff; }
    canvas { width: 100%; height: 200px; border: 2px dashed #999; border-radius: 5px; touch-action: none; }
  </style>
</head>
<body>

<div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

<form id="checklistForm">
  <div class="step active">
    <h3>1. FRAME</h3>
    <div class="item">
      <label>Baut Frame</label>
      <select name="baut_frame" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_baut_frame" placeholder="Ket NG..."></textarea>
    </div>
    <div class="item">
      <label>Bubble Leveller</label>
      <select name="bubble_leveller" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_bubble_leveller" placeholder="Ket NG..."></textarea>
    </div>
  </div>

  <div class="step">
    <h3>2. MAGAZINE</h3>
    <div class="item">
      <label>As Adjuster</label>
      <select name="as_adjuster" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_as_adjuster" placeholder="Ket NG..."></textarea>
    </div>
    <div class="item">
      <label>Baut Magazine</label>
      <select name="baut_magazine" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_baut_magazine" placeholder="Ket NG..."></textarea>
    </div>
  </div>

  <div class="step">
    <h3>3. PLATE</h3>
    <div class="item">
      <label>V-Belt</label>
      <select name="vbelt" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_vbelt" placeholder="Ket NG..."></textarea>
    </div>
    <div class="item">
      <label>Gearing/Bearing</label>
      <select name="gearing" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_gearing" placeholder="Ket NG..."></textarea>
    </div>
  </div>

  <div class="step">
    <h3>4. PANEL</h3>
    <div class="item">
      <label>Panel Komponen</label>
      <select name="panel_komponen" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_panel" placeholder="Ket NG..."></textarea>
    </div>
    <div class="item">
      <label>Instalasi Kabel</label>
      <select name="instalasi_kabel" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_kabel" placeholder="Ket NG..."></textarea>
    </div>
  </div>

  <div class="step">
    <h3>5. PNEUMATIC</h3>
    <div class="item">
      <label>Pneumatic Tubing</label>
      <select name="pneumatic_tubing" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_pneumatic" placeholder="Ket NG..."></textarea>
    </div>
    <div class="item">
      <label>Tekanan Angin</label>
      <select name="tekanan_angin" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_angin" placeholder="Ket NG..."></textarea>
    </div>
  </div>

  <div class="step">
    <h3>6. ROBOT</h3>
    <div class="item">
      <label>Dummy Robot</label>
      <select name="dummy_robot" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_dummy" placeholder="Ket NG..."></textarea>
    </div>
    <div class="item">
      <label>Static KV</label>
      <select name="static_kv" onchange="toggleNote(this)" required><option value="">--Pilih--</option><option>OK</option><option>NG</option></select>
      <textarea name="note_static" placeholder="Ket NG..."></textarea>
    </div>
  </div>

  <div class="step">
    <h3>7. SELESAI</h3>
    <label>Nama Pelaksana</label>
    <input type="text" name="nama_pelaksana" id="nama_pelaksana" required />
    <label style="margin-top:15px">Tanda Tangan</label>
    <canvas id="signaturePad"></canvas>
    <button type="button" onclick="clearSig()" style="background:red; color:#fff; margin-top:5px; padding:5px">Hapus Paraf</button>
  </div>
</form>

<div class="btn-group">
  <button type="button" class="back" onclick="prevStep()" id="btnBack">Back</button>
  <button type="button" class="next" onclick="nextStep()" id="btnNext">Lanjut</button>
</div>

<script>
const _URL = "https://duljhawudstjxibhuenv.supabase.co";
const _KEY = "PASTE_ANON_KEY_KAMU_DISINI"; 
const sb = supabase.createClient(_URL, _KEY);

let currentStep = 0;
const steps = document.querySelectorAll(".step");

function updateStep() {
  steps.forEach((s, i) => s.classList.toggle("active", i === currentStep));
  document.getElementById("progressBar").style.width = ((currentStep + 1) / steps.length) * 100 + "%";
  document.getElementById("btnBack").style.visibility = currentStep === 0 ? "hidden" : "visible";
  document.getElementById("btnNext").innerText = currentStep === steps.length - 1 ? "Kirim" : "Lanjut";
  if(currentStep === 6) setTimeout(initCanvas, 200);
}

function nextStep() {
  const inputs = steps[currentStep].querySelectorAll("select, input");
  for(let i of inputs) if(i.hasAttribute('required') && !i.value) return alert("Isi data!");
  if(currentStep < 6) { currentStep++; updateStep(); } else { submit(); }
}

function prevStep() { if(currentStep > 0) { currentStep--; updateStep(); } }

function toggleNote(s) { s.nextElementSibling.style.display = s.value === "NG" ? "block" : "none"; }

// SIGNATURE LOGIC
const canvas = document.getElementById("signaturePad");
const ctx = canvas.getContext("2d");
let drawing = false;

function initCanvas() {
  canvas.width = canvas.offsetWidth;
  canvas.height = 200;
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
}

function getPos(e) {
  const r = canvas.getBoundingClientRect();
  const c = e.touches ? e.touches[0] : e;
  return { x: c.clientX - r.left, y: c.clientY - r.top };
}

canvas.addEventListener("touchstart", (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive:false});
canvas.addEventListener("touchmove", (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive:false});
canvas.addEventListener("touchend", () => drawing = false);
function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }

async function submit() {
  const sig = canvas.toDataURL();
  if(sig.length < 2000) return alert("Paraf dulu!");
  
  const btn = document.getElementById("btnNext");
  btn.disabled = true; btn.innerText = "Sabar...";

  const data = Object.fromEntries(new FormData(document.getElementById("checklistForm")));
  data.paraf_pelaksana = sig;

  const { error } = await sb.from("pelaksana_a").insert([data]);
  if(error) { alert(error.message); btn.disabled = false; }
  else { alert("Berhasil!"); location.reload(); }
}

updateStep();
</script>
</body>
</html>
