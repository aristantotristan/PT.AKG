<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Checklist Stand Label & Robot</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #003366; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .progress-bar { height: 8px; background: #ddd; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }
    .step { display: none; }
    .step.active { display: block; }
    h3 { color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    .item { margin-bottom: 15px; }
    label { display: block; font-weight: bold; font-size: 14px; margin-bottom: 5px; }
    .std { font-size: 12px; color: #666; font-style: italic; margin-bottom: 5px; display: block; }
    select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    textarea { margin-top: 5px; display: none; height: 60px; background: #fff9c4; }
    .btn-group { display: flex; gap: 10px; }
    button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn-back { background: #bbb; }
    .btn-next { background: var(--primary); color: #white; color: white; }
    canvas { width: 100%; height: 200px; border: 2px dashed #999; border-radius: 8px; background: #fafafa; touch-action: none; }
  </style>
</head>
<body>

<div class="card">
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <form id="checklistForm">

    <div class="step active">
      <h3>1. FRAME / RANGKA</h3>
      <div class="item">
        <label>Baut Frame Rangka</label>
        <span class="std">Std: Tidak kendor/lepas</span>
        <select name="baut_frame" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_baut_frame" placeholder="Alasan NG..."></textarea>
      </div>
      <div class="item">
        <label>Bubble Leveller</label>
        <span class="std">Std: Terpasang & berfungsi benar</span>
        <select name="bubble_leveller" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_bubble_leveller" placeholder="Alasan NG..."></textarea>
      </div>
    </div>

    <div class="step">
      <h3>2. MAGAZINE LABEL</h3>
      <div class="item">
        <label>As Adjuster Plate</label>
        <span class="std">Std: Berfungsi baik</span>
        <select name="as_adjuster" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_as_adjuster" placeholder="Alasan NG..."></textarea>
      </div>
      <div class="item">
        <label>Baut Frame Magazine</label>
        <span class="std">Std: Lengkap & bersih</span>
        <select name="baut_magazine" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_baut_magazine" placeholder="Alasan NG..."></textarea>
      </div>
    </div>

    <div class="step">
      <h3>3. PLATE STAND LABEL</h3>
      <div class="item">
        <label>V-Belt</label><span class="std">Std: Tidak kendor/terlalu kencang</span>
        <select name="vbelt" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_vbelt"></textarea>
      </div>
      <div class="item">
        <label>Gear/Bushing/Bearing</label><span class="std">Std: Tidak goyang</span>
        <select name="gearing" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_gearing"></textarea>
      </div>
      <div class="item">
        <label>Vacuum Pad</label><span class="std">Std: Baut & skun kencang</span>
        <select name="vacuum_pad" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_vacuum_pad"></textarea>
      </div>
      <div class="item">
        <label>Spring/As Vacuum Pad</label><span class="std">Std: Smooth/halus</span>
        <select name="spring_as" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_spring_as"></textarea>
      </div>
    </div>

    <div class="step">
      <h3>4. PANEL KONTROL</h3>
      <div class="item">
        <label>Kondisi Panel</label><span class="std">Std: Tidak berdebu/lengket</span>
        <select name="panel_komponen" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_panel"></textarea>
      </div>
      <div class="item">
        <label>Komponen Electrical</label><span class="std">Std: Tidak kendor</span>
        <select name="komponen_electrical" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_electrical"></textarea>
      </div>
      <div class="item">
        <label>Kondisi Fan</label><span class="std">Std: Bersih/tidak berdebu</span>
        <select name="fan_kondisi" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_fan"></textarea>
      </div>
    </div>

    <div class="step">
      <h3>5. PNEUMATIC SYSTEM</h3>
      <div class="item">
        <label>Instalasi Cylinder/Tubing</label><span class="std">Std: Rapi & tidak bocor</span>
        <select name="pneumatic_tubing" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_pneumatic"></textarea>
      </div>
      <div class="item">
        <label>Solenoid Silencer</label><span class="std">Std: Dilengkapi silencer</span>
        <select name="solenoid_silencer" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_sol_silencer"></textarea>
      </div>
      <div class="item">
        <label>Tekanan Angin</label><span class="std">Std: Stabil 4-8 Bar</span>
        <select name="tekanan_angin" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_angin"></textarea>
      </div>
    </div>

    <div class="step">
      <h3>6. SISTEM ROBOT</h3>
      <div class="item">
        <label>Dummy Robot</label><span class="std">Std: Cleaning majun hitam (15 mnt)</span>
        <select name="dummy_robot" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_dummy"></textarea>
      </div>
      <div class="item">
        <label>Sistem Static</label><span class="std">Std: Nilai 9-13 Kv</span>
        <select name="static_kv" onchange="showNG(this)" required><option value="">-- Pilih --</option><option>OK</option><option>NG</option></select>
        <textarea name="note_static"></textarea>
      </div>
    </div>

    <div class="step">
      <h3>7. VALIDASI PELAKSANA</h3>
      <div class="item">
        <label>Nama Pelaksana</label>
        <input type="text" name="nama_pelaksana" id="namaInput" required placeholder="Masukkan Nama Anda">
      </div>
      <label>Tanda Tangan:</label>
      <canvas id="sigPad"></canvas>
      <button type="button" onclick="clearSig()" style="background:#f44336; color:white; margin-top:10px; padding:5px">Hapus Tanda Tangan</button>
    </div>

  </form>

  <div class="btn-group" style="margin-top:20px">
    <button type="button" class="btn-back" id="btnBack" onclick="changeStep(-1)">Kembali</button>
    <button type="button" class="btn-next" id="btnNext" onclick="changeStep(1)">Lanjut</button>
  </div>
</div>

<script>
  const _URL = "https://duljhawudstjxibhuenv.supabase.co";
  const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bGpoYXd1ZHN0anhpYmh1ZW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODI2NDksImV4cCI6MjA4MTM1ODY0OX0.R9s6oNlJjF_K89frPmWkXxcOBlO1IJL6nXwxqNV1jiQ"; 
  const sb = supabase.createClient(_URL, _KEY);

  let step = 0;
  const steps = document.querySelectorAll(".step");
  const progress = document.getElementById("progressFill");

  function changeStep(n) {
    if (n === 1) {
      const inputs = steps[step].querySelectorAll("select[required], input[required]");
      for (let i of inputs) if (!i.value) return alert("Mohon isi semua data!");
    }

    step += n;
    if (step < 0) step = 0;
    if (step >= steps.length) return submit();

    steps.forEach((s, i) => s.classList.toggle("active", i === step));
    progress.style.width = ((step + 1) / steps.length) * 100 + "%";
    document.getElementById("btnBack").style.visibility = step === 0 ? "hidden" : "visible";
    document.getElementById("btnNext").innerText = step === steps.length - 1 ? "Kirim Data" : "Lanjut";

    if (step === 6) setTimeout(resizeCanvas, 300); // Fix Paraf pas buka step terakhir
  }

  function showNG(el) { el.nextElementSibling.style.display = el.value === "NG" ? "block" : "none"; }

  // FIX PARAF LOGIC
  const canvas = document.getElementById("sigPad");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    ctx.scale(ratio, ratio);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
  }

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: t.clientX - r.left, y: t.clientY - r.top };
  }

  canvas.addEventListener("touchstart", (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive: false});
  canvas.addEventListener("touchmove", (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive: false});
  canvas.addEventListener("touchend", () => drawing = false);

  function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }

  async function submit() {
    const sig = canvas.toDataURL();
    if (sig.length < 2000) return alert("Tanda tangan wajib diisi!");

    const btn = document.getElementById("btnNext");
    btn.disabled = true; btn.innerText = "Mengirim...";

    const form = document.getElementById("checklistForm");
    const data = Object.fromEntries(new FormData(form));
    data.paraf_pelaksana = sig;

    const { error } = await sb.from("pelaksana_a").insert([data]);
    if (error) { alert(error.message); btn.disabled = false; btn.innerText = "Kirim Data"; }
    else { alert("Checklist Berhasil Disimpan!"); location.reload(); }
  }

  changeStep(0);
</script>
</body>
</html>
