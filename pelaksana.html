<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Checklist Pelaksana - CHSLR</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #003366; --accent: #ffcc00; --bg: #f2f5f8; --text: #333; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
    
    .card { background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); overflow: hidden; max-width: 600px; margin: auto; }
    .header { background: var(--primary); color: #fff; padding: 20px; text-align: center; font-weight: bold; font-size: 18px; }
    
    .progress-bar { height: 8px; background: #e0e0e0; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    
    .step { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
    .step.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    h3 { color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 0; font-size: 16px; }
    
    .machine-select-box { background: #eef2f7; padding: 15px; border-radius: 10px; border: 2px dashed var(--primary); text-align: center; }
    select, input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; outline: none; transition: 0.3s; }
    select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,51,102,0.1); }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background: #f8f9fa; border: 1px solid #eee; padding: 10px; font-size: 12px; text-align: left; color: #666; }
    td { border: 1px solid #eee; padding: 10px; vertical-align: top; }
    
    .std-text { font-size: 11px; color: #d32f2f; font-weight: bold; display: block; margin-top: 4px; }
    textarea { width: 100%; margin-top: 8px; display: none; height: 60px; border: 1px solid #ffcc00; border-radius: 6px; background: #fffde7; padding: 8px; box-sizing: border-box; }

    .canvas-wrapper { border: 2px solid #ddd; border-radius: 8px; background: #fafafa; margin-top: 10px; position: relative; touch-action: none; }
    canvas { width: 100%; height: 200px; display: block; border-radius: 8px; }
    
    .footer { display: flex; gap: 12px; padding: 20px; background: #f8f9fa; border-top: 1px solid #eee; }
    button { flex: 1; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 15px; }
    .btn-prev { background: #e0e0e0; color: #666; }
    .btn-next { background: var(--primary); color: #fff; }
    .btn-clear { background: #fee2e2; color: #dc2626; margin-top: 8px; padding: 8px; font-size: 12px; border: 1px solid #fecaca; }
    button:active { transform: scale(0.98); }
    button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

<div class="card">
  <div class="header">CHECKLIST STAND LABEL & ROBOT</div>
  <div class="progress-bar"><div class="progress-fill" id="bar"></div></div>

  <form id="checklistForm">
    <div class="step active">
      <h3>STEP 0: IDENTITAS MESIN</h3>
      <div class="machine-select-box">
        <label style="font-weight: bold; margin-bottom: 10px; display: block;">Pilih Nomor Mesin:</label>
        <select name="nomor_mesin" id="nomor_mesin" required>
          <option value="">-- PILIH MESIN --</option>
          <script>
            for(let i=1; i<=30; i++){
              let val = "CHSLR-" + i.toString().padStart(2, '0');
              document.write(`<option value="${val}">${val}</option>`);
            }
          </script>
        </select>
      </div>
      <p style="font-size: 12px; color: #777; margin-top: 15px; line-height: 1.4;">
        * Pastikan nomor mesin sesuai dengan nameplate di lapangan sebelum melanjutkan.
      </p>
    </div>

    <div class="step">
      <h3>STEP 1: FRAME & MAGAZINE</h3>
      <table>
        <tr><th>Pengecekan</th><th width="90">Hasil</th></tr>
        <tr>
          <td>Baut frame rangka<br><span class="std-text">Std: Tidak kendor/lepas</span></td>
          <td><select name="baut_frame" onchange="hNG(this)" required><option value="">-</option><option>OK</option><option>NG</option></select><textarea name="note_baut_frame" placeholder="Sebutkan kendala..."></textarea></td>
        </tr>
        <tr>
          <td>Bubble leveller<br><span class="std-text">Std: Berfungsi benar</span></td>
          <td><select name="bubble_leveller" onchange="hNG(this)" required><option value="">-</option><option>OK</option><option>NG</option></select><textarea name="note_bubble_leveller" placeholder="Sebutkan kendala..."></textarea></td>
        </tr>
      </table>
    </div>

    <div class="step">
      <h3>STEP 2: PLATE STAND LABEL</h3>
      <table>
        <tr><th>Pengecekan</th><th width="90">Hasil</th></tr>
        <tr>
          <td>V-Belt<br><span class="std-text">Std: Tidak kendor/kencang</span></td>
          <td><select name="vbelt" onchange="hNG(this)" required><option value="">-</option><option>OK</option><option>NG</option></select><textarea name="note_vbelt" placeholder="Sebutkan kendala..."></textarea></td>
        </tr>
        <tr>
          <td>Vacuum pad<br><span class="std-text">Std: Baut & skun kencang</span></td>
          <td><select name="vacuum_pad" onchange="hNG(this)" required><option value="">-</option><option>OK</option><option>NG</option></select><textarea name="note_vacuum_pad" placeholder="Sebutkan kendala..."></textarea></td>
        </tr>
      </table>
    </div>

    <div class="step">
      <h3>STEP 3: PNEUMATIC & ROBOT</h3>
      <table>
        <tr><th>Pengecekan</th><th width="90">Hasil</th></tr>
        <tr>
          <td>Fungsi Vacuum Gen<br><span class="std-text">Std: 0.4 - 0.5 kPa</span></td>
          <td><select name="fungsi_vac_gen" onchange="hNG(this)" required><option value="">-</option><option>OK</option><option>NG</option></select><textarea name="note_vac_gen" placeholder="Sebutkan kendala..."></textarea></td>
        </tr>
        <tr>
          <td>Dummy Robot<br><span class="std-text">Std: Majun hitam (15m)</span></td>
          <td><select name="dummy_robot" onchange="hNG(this)" required><option value="">-</option><option>OK</option><option>NG</option></select><textarea name="note_dummy" placeholder="Sebutkan kendala..."></textarea></td>
        </tr>
      </table>
    </div>

    <div class="step">
      <h3>STEP 4: FINALISASI</h3>
      <label><b>Nama Mekanik Pelaksana:</b></label>
      <input type="text" name="nama_pelaksana" placeholder="Ketik Nama Lengkap" required style="margin-top:8px">
      
      <label style="margin-top:20px; display:block"><b>Tanda Tangan Digital:</b></label>
      <div class="canvas-wrapper">
        <canvas id="canvas"></canvas>
      </div>
      <button type="button" class="btn-clear" onclick="clr()">HAPUS TANDA TANGAN</button>
      
      <input type="hidden" name="tanggal" id="tgl_hidden">
    </div>
  </form>

  <div class="footer">
    <button type="button" class="btn-prev" id="bBack" onclick="nav(-1)">KEMBALI</button>
    <button type="button" class="btn-next" id="bNext" onclick="nav(1)">LANJUT</button>
  </div>
</div>

<script>
  const _URL = "https://duljhawudstjxibhuenv.supabase.co";
  const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bGpoYXd1ZHN0anhpYmh1ZW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODI2NDksImV4cCI6MjA4MTM1ODY0OX0.R9s6oNlJjF_K89frPmWkXxcOBlO1IJL6nXwxqNV1jiQ";
  const sb = supabase.createClient(_URL, _KEY);

  let step = 0;
  const steps = document.querySelectorAll(".step");
  const fill = document.getElementById("bar");
  const cvs = document.getElementById("canvas");
  const ctx = cvs.getContext("2d");
  let drawing = false;

  // Navigasi
  function nav(n) {
    if (n === 1) {
      const inputs = steps[step].querySelectorAll("select[required], input[required]");
      for (let i of inputs) {
        if (!i.value) return alert("Mohon lengkapi data di tahap ini!");
      }
    }
    
    step += n;
    if (step >= steps.length) return submit();
    show();
  }

  function show() {
    steps.forEach((s, i) => s.classList.toggle("active", i === step));
    fill.style.width = ((step + 1) / steps.length) * 100 + "%";
    document.getElementById("bBack").style.visibility = step === 0 ? "hidden" : "visible";
    document.getElementById("bNext").innerText = step === steps.length - 1 ? "SIMPAN DATA" : "LANJUT";
    
    // Init canvas saat sampai step terakhir
    if (step === steps.length - 1) {
      setTimeout(initCanvas, 300);
      document.getElementById("tgl_hidden").value = new Date().toISOString().split('T')[0];
    }
  }

  function hNG(s) {
    const area = s.nextElementSibling;
    if(area && area.tagName === "TEXTAREA") {
      area.style.display = s.value === "NG" ? "block" : "none";
      if(s.value !== "NG") area.value = "";
    }
  }

  // Tanda Tangan
  function initCanvas() {
    const r = cvs.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    cvs.width = r.width * dpr;
    cvs.height = r.height * dpr;
    ctx.scale(dpr, dpr);
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000066";
  }

  function getXY(e) {
    const r = cvs.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: t.clientX - r.left, y: t.clientY - r.top };
  }

  function start(e) { 
    drawing = true; 
    const p = getXY(e); 
    ctx.beginPath(); 
    ctx.moveTo(p.x, p.y); 
    if(e.touches) e.preventDefault(); 
  }
  
  function draw(e) { 
    if(!drawing) return; 
    const p = getXY(e); 
    ctx.lineTo(p.x, p.y); 
    ctx.stroke(); 
    if(e.touches) e.preventDefault(); 
  }
  
  function stop() { drawing = false; }

  cvs.addEventListener("mousedown", start);
  cvs.addEventListener("mousemove", draw);
  window.addEventListener("mouseup", stop);
  cvs.addEventListener("touchstart", start, {passive:false});
  cvs.addEventListener("touchmove", draw, {passive:false});
  cvs.addEventListener("touchend", stop);

  function clr() { ctx.clearRect(0, 0, cvs.width, cvs.height); }

  // Submit
  async function submit() {
    const img = cvs.toDataURL();
    if (img.length < 2000) return alert("Tanda tangan wajib diisi!");

    const btn = document.getElementById("bNext");
    btn.disabled = true;
    btn.innerText = "⏳ Menyimpan...";

    const form = document.getElementById("checklistForm");
    const fd = Object.fromEntries(new FormData(form));
    fd.paraf_pelaksana = img;

    try {
      const { error } = await sb.from("pelaksana_a").insert([fd]);
      if (error) throw error;
      alert("✅ Data Berhasil Disimpan!");
      location.reload();
    } catch (err) {
      alert("❌ Gagal: " + err.message);
      btn.disabled = false;
      btn.innerText = "SIMPAN DATA";
    }
  }

  show();
</script>
</body>
</html>
