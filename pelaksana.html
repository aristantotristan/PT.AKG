<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pelaksana Checklist</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  padding:16px;
}

.step { display:none; background:#fff; padding:16px; border-radius:10px; }
.step.active { display:block; }

button {
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  font-size:16px;
}

.next { background:#003366; color:#fff; }
.back { background:#ccc; }

canvas {
  border:2px dashed #666;
  width:100%;
  height:180px;
  background:#fff;
  touch-action:none;
}
</style>
</head>

<body>

<h2>Checklist Pelaksana</h2>

<!-- STEP 1 -->
<div class="step active">
  <h3>FRAME STAND LABEL</h3>

  <label>Baut rangka</label>
  <select>
    <option>OK</option>
    <option>NG</option>
  </select>

  <label>Bubble Leveller</label>
  <select>
    <option>OK</option>
    <option>NG</option>
  </select>
</div>

<!-- STEP 2 -->
<div class="step">
  <h3>MAGAZINE LABEL</h3>

  <label>Adjuster Plate</label>
  <select>
    <option>OK</option>
    <option>NG</option>
  </select>

  <label>Baut Magazine</label>
  <select>
    <option>OK</option>
    <option>NG</option>
  </select>
</div>

<!-- STEP 3 -->
<div class="step">
  <h3>TANDA TANGAN</h3>

  <label>Nama Pelaksana</label>
  <input id="nama" placeholder="Nama mekanik">

  <p>Paraf:</p>
  <canvas id="ttd"></canvas>

  <button onclick="clearCanvas()">Clear TTD</button>
</div>

<button class="back" onclick="prev()">Back</button>
<button class="next" onclick="next()">Next / Submit</button>

<script>
/* ================= STEP ================= */
const steps = document.querySelectorAll(".step");
let step = 0;

function show() {
  steps.forEach((s,i)=>s.classList.toggle("active", i===step));
}
function next() {
  if(step < steps.length-1){
    step++; show();
  } else {
    submit();
  }
}
function prev() {
  if(step>0){ step--; show(); }
}

/* ================= CANVAS SIGNATURE (FIXED) ================= */
const canvas = document.getElementById("ttd");
const ctx = canvas.getContext("2d");

function resize() {
  const ratio = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  ctx.setTransform(ratio,0,0,ratio,0,0);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
}
resize();
window.addEventListener("resize", resize);

let draw = false;

canvas.addEventListener("mousedown", e => {
  draw = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("mousemove", e => {
  if(!draw) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("mouseup", ()=> draw=false);

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  draw = true;
  const t = e.touches[0];
  const r = canvas.getBoundingClientRect();
  ctx.beginPath();
  ctx.moveTo(t.clientX-r.left, t.clientY-r.top);
});
canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  if(!draw) return;
  const t = e.touches[0];
  const r = canvas.getBoundingClientRect();
  ctx.lineTo(t.clientX-r.left, t.clientY-r.top);
  ctx.stroke();
});
canvas.addEventListener("touchend", ()=> draw=false);

function clearCanvas(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://duljhawudstjxibhuenv.supabase.co",
  "ISI_ANON_KEY_DISINI"
);

async function submit(){
  const img = canvas.toDataURL();

  if(img.length < 1000){
    alert("TTD belum diisi!");
    return;
  }

  const { error } = await sb.from("pelaksana_A").insert({
    nama_pelaksana: document.getElementById("nama").value,
    ttd_pelaksana: img,
    created_at: new Date()
  });

  if(error){
    alert(error.message);
  } else {
    alert("Checklist terkirim!");
    location.reload();
  }
}
</script>

</body>
</html>
