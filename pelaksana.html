<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist Harian Stand Label & Robot - Pelaksana</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 16px;
}

h2 {
  text-align: center;
  margin-bottom: 10px;
}

.progress {
  width: 100%;
  background: #ddd;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 16px;
}

.progress-bar {
  height: 10px;
  width: 0%;
  background: #003366;
}

.step {
  display: none;
  background: #fff;
  padding: 16px;
  border-radius: 10px;
}

.step.active {
  display: block;
}

.item {
  margin-bottom: 12px;
}

label {
  font-size: 14px;
  display: block;
  margin-bottom: 4px;
}

select, textarea, input {
  width: 100%;
  padding: 6px;
}

textarea {
  display: none;
}

.btn-group {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

button {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
}

.back { background: #ccc; }
.next { background: #003366; color: #fff; }

canvas {
  width: 100%;
  height: 160px;
  border: 1px dashed #999;
  border-radius: 8px;
  touch-action: none;
}
</style>
</head>

<body>

<h2>Checklist Harian<br>Stand Label & Robot</h2>

<div class="progress">
  <div class="progress-bar" id="progressBar"></div>
</div>

<!-- ===================== STEP 1 ===================== -->
<div class="step active">
<h3>FRAME / RANGKA</h3>

<div class="item">
<label>Baut frame rangka</label>
<select data-key="frame_baut" onchange="toggleNote(this)">
<option value="">-- Pilih --</option>
<option>OK</option>
<option>NG</option>
</select>
<textarea placeholder="Keterangan jika NG"></textarea>
</div>

<div class="item">
<label>Bubble leveller</label>
<select data-key="frame_bubble" onchange="toggleNote(this)">
<option value="">-- Pilih --</option>
<option>OK</option>
<option>NG</option>
</select>
<textarea placeholder="Keterangan jika NG"></textarea>
</div>
</div>

<!-- ===================== STEP 2 ===================== -->
<div class="step">
<h3>MAGAZINE LABEL</h3>

<div class="item">
<label>As adjuster plate</label>
<select data-key="mag_adjuster" onchange="toggleNote(this)">
<option value="">-- Pilih --</option>
<option>OK</option>
<option>NG</option>
</select>
<textarea></textarea>
</div>

<div class="item">
<label>Baut frame magazine</label>
<select data-key="mag_baut" onchange="toggleNote(this)">
<option value="">-- Pilih --</option>
<option>OK</option>
<option>NG</option>
</select>
<textarea></textarea>
</div>
</div>

<!-- ===================== STEP 3 ===================== -->
<div class="step">
<h3>PLATE STAND LABEL</h3>

<div class="item"><label>V-Belt</label><select data-key="plate_vbelt" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Gear / Bushing / Bearing</label><select data-key="plate_gear" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Vacuum Pad</label><select data-key="plate_vacuum" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Spring / As Vacuum</label><select data-key="plate_spring" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Linear Bearing SL</label><select data-key="plate_linear" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Tutup Rail</label><select data-key="plate_rail" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
</div>

<!-- ===================== STEP 4 ===================== -->
<div class="step">
<h3>PANEL KONTROL</h3>

<div class="item"><label>Kondisi Panel</label><select data-key="panel_kondisi" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Komponen Electrical</label><select data-key="panel_electrical" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Instalasi Kabel</label><select data-key="panel_kabel" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Solenoid Valve</label><select data-key="panel_solenoid" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Fan Panel</label><select data-key="panel_fan" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
</div>

<!-- ===================== STEP 5 ===================== -->
<div class="step">
<h3>SISTEM PNEUMATIC</h3>

<div class="item"><label>Instalasi Pneumatic</label><select data-key="pneu_instalasi" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Tekanan Angin (4–8 bar)</label><select data-key="pneu_tekanan" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
</div>

<!-- ===================== STEP 6 ===================== -->
<div class="step">
<h3>SISTEM ROBOT</h3>

<div class="item"><label>Dummy Robot (cleaning)</label><select data-key="robot_dummy" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
<div class="item"><label>Static (9–13 Kv)</label><select data-key="robot_static" onchange="toggleNote(this)"><option></option><option>OK</option><option>NG</option></select><textarea></textarea></div>
</div>

<!-- ===================== STEP 7 PARAF ===================== -->
<div class="step">
<h3>PARAF PELAKSANA</h3>

<label>Nama Pelaksana</label>
<input id="namaPelaksana" placeholder="Nama Mekanik">

<p>Tanda Tangan:</p>
<canvas id="signaturePad"></canvas>

<button onclick="clearSignature()">Clear TTD</button>
</div>

<div class="btn-group">
<button class="back" onclick="prevStep()">Back</button>
<button class="next" onclick="nextStep()">Next</button>
</div>

<script>
/* ===== SUPABASE ===== */
const supabase = supabase.createClient(
  "https://duljhawudstjxibhuenv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1bGpoYXd1ZHN0anhpYmh1ZW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODI2NDksImV4cCI6MjA4MTM1ODY0OX0.R9s6oNlJjF_K89frPmWkXxcOBlO1IJL6nXwxqNV1jiQ"
);

/* ===== STEP ===== */
const steps = document.querySelectorAll('.step');
const progressBar = document.getElementById('progressBar');
let currentStep = 0;

function updateStep(){
  steps.forEach((s,i)=>s.classList.toggle('active',i===currentStep));
  progressBar.style.width = ((currentStep+1)/steps.length)*100+"%";
}

function nextStep(){
  if(currentStep === steps.length-1){
    submitData();
  } else {
    currentStep++;
    updateStep();
  }
}

function prevStep(){
  if(currentStep>0){ currentStep--; updateStep(); }
}

function toggleNote(sel){
  sel.nextElementSibling.style.display = sel.value==="NG"?"block":"none";
}

/* ===== SIGNATURE ===== */
const canvas = document.getElementById("signaturePad");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  const ratio = Math.max(window.devicePixelRatio||1,1);
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * ratio;
  canvas.height = rect.height * ratio;
  ctx.scale(ratio,ratio);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
}
resizeCanvas();

let drawing=false;
canvas.addEventListener("pointerdown",e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
canvas.addEventListener("pointermove",e=>{if(!drawing)return;ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();});
canvas.addEventListener("pointerup",()=>drawing=false);

function clearSignature(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* ===== SUBMIT ===== */
async function submitData(){
  const nama = document.getElementById("namaPelaksana").value;
  const signature = canvas.toDataURL();

  if(!nama || signature.length < 500){
    alert("Nama & tanda tangan WAJIB");
    return;
  }

  const data = { nama_pelaksana: nama, signature, tanggal: new Date(), status:"PELaksana" };

  document.querySelectorAll("select").forEach(s=>{
    data[s.dataset.key] = s.value;
    data[s.dataset.key+"_note"] = s.nextElementSibling?.value || "";
  });

  const { error } = await supabase.from("pelaksana_A").insert([data]);

  if(error){
    alert("Gagal simpan: "+error.message);
  } else {
    alert("Checklist & Paraf berhasil disimpan");
    location.href = "index.html";
  }
}

updateStep();
</script>

</body>
</html>
