<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CLHMI â€“ Daily Machine Inspection Audit Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- PDF EXPORT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* ======================================================
   GLOBAL / ISO BASE
====================================================== */
:root {
    --border: #000;
    --text: #111;
    --muted: #475569;
}

body {
    font-family: Arial, Helvetica, sans-serif;
    background: #f1f5f9;
    margin: 0;
    padding: 20px;
    color: var(--text);
}

/* ======================================================
   CONTROL AREA (NOT PRINTED)
====================================================== */
.no-print {
    max-width: 900px;
    margin: auto auto 20px;
    background: #fff;
    border: 1px solid #cbd5e1;
    padding: 15px;
    display: flex;
    gap: 15px;
    align-items: flex-end;
}

.no-print label {
    font-size: 12px;
    font-weight: bold;
}

.no-print input {
    padding: 8px;
    border: 1px solid #cbd5e1;
}

.no-print button {
    padding: 10px 20px;
    font-weight: bold;
    cursor: pointer;
}

/* ======================================================
   AUDIT DOCUMENT
====================================================== */
#audit-container {
    max-width: 900px;
    margin: auto;
}

.audit-page {
    background: #fff;
    border: 2px solid var(--border);
    margin-bottom: 40px;
    page-break-inside: avoid;
}

/* ======================================================
   HEADER
====================================================== */
.audit-header {
    display: grid;
    grid-template-columns: 180px 1fr 220px;
    border-bottom: 2px solid var(--border);
}

.header-box {
    padding: 10px;
    border-right: 2px solid var(--border);
    font-size: 11px;
}

.header-box:last-child {
    border-right: none;
}

.header-title {
    text-align: center;
}

.header-title h2 {
    margin: 5px 0;
    font-size: 16px;
}

.status-stamp {
    display: inline-block;
    padding: 4px 12px;
    border: 2px solid;
    font-weight: bold;
    margin-top: 5px;
}

.stamp-done { color: #166534; border-color: #166534; }
.stamp-wait { color: #92400e; border-color: #92400e; }

/* ======================================================
   INFO GRID
====================================================== */
.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-bottom: 1px solid var(--border);
}

.info-cell {
    padding: 10px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    font-size: 12px;
}

.info-cell:last-child {
    border-right: none;
}

/* ======================================================
   CONTENT SECTIONS
====================================================== */
.section {
    padding: 12px;
    border-bottom: 1px solid var(--border);
}

.section-title {
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    margin-bottom: 5px;
}

.section-text {
    font-size: 13px;
    line-height: 1.5;
}

/* ======================================================
   SIGNATURE BLOCK
====================================================== */
.signature-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    border-top: 2px solid var(--border);
    text-align: center;
}

.sig-col {
    border-right: 1px solid var(--border);
    padding: 10px;
    height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.sig-col:last-child {
    border-right: none;
}

.sig-img {
    max-height: 70px;
}

.sig-name {
    font-weight: bold;
    text-transform: uppercase;
    text-decoration: underline;
    font-size: 12px;
}

.sig-role {
    font-size: 11px;
    color: var(--muted);
}

/* ======================================================
   PRINT RULES
====================================================== */
@media print {
    body { background: #fff; }
    .no-print { display: none; }
}
</style>
</head>

<body>

<!-- CONTROL -->
<div class="no-print">
    <div>
        <label>From Date</label>
        <input type="date" id="from">
    </div>
    <div>
        <label>To Date</label>
        <input type="date" id="to">
    </div>
    <button onclick="loadReport()">Generate</button>
    <button onclick="exportPDF()">Export PDF</button>
</div>

<!-- REPORT -->
<div id="audit-container"></div>

<script>
const sb = supabase.createClient(
    "https://duljhawudstjxibhuenv.supabase.co",
    "YOUR_PUBLIC_ANON_KEY"
);

async function loadReport() {
    const from = document.getElementById("from").value;
    const to = document.getElementById("to").value;

    if (!from || !to) {
        alert("Date range is mandatory.");
        return;
    }

    const { data } = await sb
        .from("pelaksana_b")
        .select("*")
        .gte("tanggal", from)
        .lte("tanggal", to)
        .order("tanggal", { ascending: false });

    const container = document.getElementById("audit-container");
    container.innerHTML = "";

    data.forEach(row => {
        container.innerHTML += `
        <div class="audit-page">
            <div class="audit-header">
                <div class="header-box">CLHMI SYSTEM</div>
                <div class="header-box header-title">
                    <h2>DAILY MACHINE INSPECTION REPORT</h2>
                    <div class="status-stamp ${row.status_final === 'DONE' ? 'stamp-done' : 'stamp-wait'}">
                        ${row.status_final === 'DONE' ? 'VERIFIED' : 'IN PROGRESS'}
                    </div>
                </div>
                <div class="header-box">
                    Doc No: AF.SP 05.13.Rev-00<br>
                    Record ID: ${row.id}<br>
                    Print Date: ${new Date().toLocaleDateString()}
                </div>
            </div>

            <div class="info-grid">
                <div class="info-cell"><b>Machine / Unit</b><br>${row.nomor_mesin}</div>
                <div class="info-cell"><b>Inspection Date</b><br>${row.tanggal}</div>
            </div>

            <div class="section">
                <div class="section-title">A. Operator Inspection</div>
                <div class="section-text">
                    Condition: ${row.kondisi_umum}<br>
                    Notes: ${row.keterangan_ng || 'No abnormality detected.'}
                </div>
            </div>

            <div class="section">
                <div class="section-title">B. Field Verification (Coordinator)</div>
                <div class="section-text">
                    ${row.catatan_konfirmasi || 'Field verification has not been completed.'}
                </div>
            </div>

            <div class="section">
                <div class="section-title">C. Final Decision (Superintendent)</div>
                <div class="section-text">
                    Based on the inspection and verification results, the unit is declared
                    <b>${row.status_final === 'DONE' ? 'FIT FOR OPERATION' : 'UNDER MONITORING'}</b>.
                </div>
            </div>

            <div class="signature-row">
                <div class="sig-col">
                    <div>Prepared by</div>
                    <img class="sig-img" src="${row.paraf_pelaksana}">
                    <div>
                        <div class="sig-name">${row.nama_pelaksana}</div>
                        <div class="sig-role">Operator</div>
                    </div>
                </div>
                <div class="sig-col">
                    <div>Verified by</div>
                    ${row.paraf_koordinator ? `<img class="sig-img" src="${row.paraf_koordinator}">` : ''}
                    <div>
                        <div class="sig-name">${row.nama_koordinator || '-'}</div>
                        <div class="sig-role">Coordinator</div>
                    </div>
                </div>
                <div class="sig-col">
                    <div>Approved by</div>
                    ${row.paraf_superintendent ? `<img class="sig-img" src="${row.paraf_superintendent}">` : ''}
                    <div>
                        <div class="sig-name">${row.nama_superintendent || '-'}</div>
                        <div class="sig-role">Superintendent</div>
                    </div>
                </div>
            </div>
        </div>`;
    });
}

function exportPDF() {
    html2pdf().from(document.getElementById("audit-container")).save();
}
</script>

</body>
</html>
