<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>CHECKLIST HARIAN MESIN INJECTION</title>

<style>
@page { size: A4 portrait; margin: 10mm 12mm; }
body { font-family: Arial, Helvetica, sans-serif; font-size: 9.5pt; margin:0; }
table { border-collapse: collapse; width:100%; }
td, th { border:1px solid #000; padding:3px; text-align:center; }

.header td { border:2px solid #000; padding:8px; }
.header-center { font-size:15pt; font-weight:bold; }

.checklist th, .checklist td { font-size:8pt; height:22px; }
.jenis { text-align:left; padding-left:6px; }
.day-cell { width:1.9%; }

.selectors {
  margin:10px 0;
  text-align:right;
}
#status {
  text-align:center;
  font-weight:bold;
  margin:8px 0;
  color:#c00;
}

.signature-table td {
  height:100px;
  vertical-align:bottom;
}

@media print {
  .selectors, #status { display:none; }
}
</style>
</head>

<body>

<div class="selectors">
  Mesin:
  <select id="machine"></select>
  Bulan:
  <select id="month"></select>
  Tahun:
  <select id="year"></select>
</div>

<div id="status"></div>

<table class="header">
<tr>
  <td width="20%">
    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" style="max-height:60px">
  </td>
  <td class="header-center" width="60%">CHECKLIST HARIAN MESIN INJECTION</td>
  <td width="20%" style="font-size:8pt">
    No Dok: AF.SP 05.13<br>
    Rev: 00<br>
    Hal: 1/1
  </td>
</tr>
</table>

<table class="checklist" style="margin-top:10px">
<thead>
<tr>
  <th>No</th>
  <th colspan="2">Jenis Pengecekan</th>
  <th>Standard</th>
  <th>Metode</th>
  <th>Catatan</th>
  <th colspan="31">Tanggal</th>
</tr>
<tr>
  <th></th><th colspan="2"></th><th></th><th></th><th></th>
  <!-- 1–31 -->
  <script>
    for(let i=1;i<=31;i++){
      document.write(`<th class="day-cell">${i}</th>`);
    }
  </script>
</tr>
</thead>

<tbody>
<tr>
  <td>1</td>
  <td colspan="2" class="jenis"><b>Mekanikal</b></td>
  <td></td><td></td><td></td>
  <script>
    for(let i=1;i<=31;i++){
      document.write(`<td class="day-cell" data-day="${i}"></td>`);
    }
  </script>
</tr>

<tr>
  <td>4</td>
  <td colspan="2" class="jenis">Paraf Pelaksana</td>
  <td></td><td></td><td></td>
  <script>
    for(let i=1;i<=31;i++){
      document.write(`<td class="day-cell" data-day="${i}"></td>`);
    }
  </script>
</tr>
</tbody>
</table>

<br>

<table class="signature-table" width="100%">
<tr>
<td>
  Prepared by<br><br>
  Nama: <span id="sig-pelaksana"></span>
</td>
<td>
  Checked by<br><br>
  Nama: <span id="sig-koordinator"></span>
</td>
<td>
  Approved by<br><br>
  Nama: <span id="sig-superintendent"></span>
</td>
</tr>
</table>

<!-- SUPABASE CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ==========================
   CONFIG
========================== */
const SUPABASE_URL = "https://duljhawudstjxibhuenv.supabase.co";
const SUPABASE_KEY = "PASTE_ANON_KEY_KAMU";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================
   INIT SELECTORS
========================== */
const machineList = [
"LIANXIN 80 T (TOAD)",
"WIBA 270 T (NEBULA)",
"WIBA 240 T (SPIDERMAN)",
"WIBA 210 T (THOR)",
"WIBA 350 T (IRON MAN)",
"ARBURG 320 T (STAR LORD)",
"WIBA 500 T (STEVE ROGERS)",
"WIBA 500 T (THANOS)",
"FCS 220 T (BLACKWIDOW)",
"ENGEL 220 T (DEADPOOL)",
"ARBURG 200 T (WOLVERINE)",
"FCS 380 T (LOKI)",
"ENGEL 380 T (INHUMANS)",
"ENGEL 380 T (HULK)",
"NPC 400 T (WANDA)",
"ENGEL 280 T (DOCTOR STRANGE)",
"FCS 100 T (ANTMAN)",
"NPC 160 T (WASP)",
"NPC 160 T (WONG)",
"FCS 150 T (ROCKET)",
"FCS 150 T (MANTIS)",
"NPC 160 T (SHANCHI)",
"NPC 260 T (VISION)",
"NPC 200 T (MAGNETO)",
"FCS 100 T (NICK FURRY)",
"FCS 250 T (CYCLOPS)",
"NPC 260 T (HAWKEYE)",
"EXTRUDER"
];

const machineSel = document.getElementById("machine");
machineSel.innerHTML = `<option value="">Pilih Mesin</option>`;
machineList.forEach(m=>{
  machineSel.innerHTML += `<option value="${m}">${m}</option>`;
});

const monthSel = document.getElementById("month");
const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
months.forEach((m,i)=>{
  monthSel.innerHTML += `<option value="${i+1}">${m}</option>`;
});
monthSel.value = new Date().getMonth()+1;

const yearSel = document.getElementById("year");
const nowY = new Date().getFullYear();
for(let y=nowY-2;y<=nowY+1;y++){
  yearSel.innerHTML += `<option value="${y}">${y}</option>`;
}
yearSel.value = nowY;

/* ==========================
   LOAD DATA
========================== */
async function loadData(){
  document.querySelectorAll(".day-cell[data-day]").forEach(c=>c.textContent="");
  document.getElementById("sig-pelaksana").textContent="";
  document.getElementById("sig-koordinator").textContent="";
  document.getElementById("sig-superintendent").textContent="";
  document.getElementById("status").textContent="";

  const mesin = machineSel.value;
  if(!mesin) return;

  const m = monthSel.value.padStart(2,"0");
  const y = yearSel.value;

  const start = `${y}-${m}-01`;
  const end   = `${y}-${m}-31`;

  const { data, error } = await supabase
    .from("pelaksana_b")
    .select("*")
    .eq("nomor_mesin", mesin)
    .gte("tanggal", start)
    .lte("tanggal", end)
    .order("tanggal");

  if(error){
    document.getElementById("status").textContent="Gagal ambil data";
    console.error(error);
    return;
  }

  if(!data || data.length===0){
    document.getElementById("status").textContent="Tidak ada data";
    return;
  }

  data.forEach(r=>{
    const d = new Date(r.tanggal).getDate();
    let mark = "";
    if(r.kondisi_umum==="OK") mark="√";
    if(r.kondisi_umum==="NG") mark="x";
    if(r.kondisi_umum==="REPAIR") mark="o";

    document.querySelectorAll(`.day-cell[data-day="${d}"]`)
      .forEach(c=>c.textContent=mark);
  });

  const last = data[data.length-1];
  document.getElementById("sig-pelaksana").textContent = last.nama_pelaksana||"";
  if(last.status_koordinator==="Verified"){
    document.getElementById("sig-koordinator").textContent = last.nama_koordinator||"";
  }
  if(last.status_final==="Approved"){
    document.getElementById("sig-superintendent").textContent = last.nama_superintendent||"";
  }
}

machineSel.onchange = loadData;
monthSel.onchange = loadData;
yearSel.onchange = loadData;
</script>

</body>
</html>
